<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>spec - Shane Dean 笔记</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "spec";
        var mkdocs_page_input_path = "ovirt/engine/spec.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Shane Dean 笔记
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">linux</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/shell/">shell语法</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cs/bpf/">bpf</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/libseccomp/">libseccomp</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/kbuild/">kbuild</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/autoconf_automake/">autoconf 和 automake</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">otopi</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../otopi/analyze/">otopi分析</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../otopi/otopi_in_ovirt_engine/">在ovirt-engine的使用</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ovirt-engine</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../development_environment/">开发环境</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">spec</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../makefile/">makefile</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../maven/">maven</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">密码学</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cs/cryptology/"><图解密码学> note</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">算法</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../algorithm/toposort/">toposort</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">java</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../java/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/intro/">inject</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Shane Dean 笔记</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ovirt-engine</li>
      <li class="breadcrumb-item active">spec</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ShaneDean/note/blob/master/docs/ovirt/engine/spec.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">前言</h1>
<p>以 ovirt-enigne-4.3为例，分析engine是如何打包成 rpm 的。</p>
<p><a href="https://rpm.org/user_doc/macros.html">spec-macro</a>,</p>
<p><a href="https://rpm-packaging-guide.github.io/">rpm-package-guide</a></p>
<p><a href="http://ftp.rpm.org/max-rpm/index.html">maximum-rpm</a></p>
<h1 id="rpm">rpm</h1>
<h1 id="spec">spec</h1>
<p>spec 文件是rpmbuild的工作手册，手册里面定义了构建系统在各个阶段中执行的命令。</p>
<p>spec文件由不同的条目组成，具体如下：</p>
<ul>
<li>注释    comments    人类阅读使用，rpm会忽略</li>
<li>标签    tags        定义数据</li>
<li>脚本    scripts     包含了特定时间执行的命令</li>
<li>宏      macros      </li>
<li>%files列表          pkg需要包含的文件列表</li>
<li>指令    directives  处理%files列表的方式</li>
<li>条件    conditionals    执行系统、架构相关的预处理工作</li>
</ul>
<p>注释：</p>
<pre><code># 后面的内容
</code></pre>
<p>注释也可以展开 但需要使用\%\%进行转义</p>
<h2 id="tags">标签 tags</h2>
<p>格式</p>
<pre><code>&lt;something&gt;:&lt;something-else&gt;
</code></pre>
<p><strong>somethin</strong> 大小写、距离 都不敏感</p>
<p>内置：
-   Preamble    变量，Package Naming Tags
    -   Name        包名
    -   Version     包版本
    -   Release     发布次数，每次发布递增，新版本产生式时重置为1，1%{?dist}
    -   Summary   <br />
    -   License     license版权
    -   URL
    -   Source0     上游的源代码，应当是远程可靠的访问地址
    -   Patch0      上游补丁，应当是远程可靠的访问地址
    -   BuildArch   如果pkg架构无关，则为noarch，如果相关则为架构缩写
    -   BuildRequires   构建依赖
    -   Requires    运行依赖
    -   ExcludeArch 不支持架构
-   Body        指令集合， Descriptive Tags
    -   %description    包描述内容
    -   %files          会被install的文件列表
    -   %changelog      发型记录</p>
<h2 id="script">脚本 script</h2>
<p>分类</p>
<ul>
<li>%prep           一系列命令来准备软件的构建环境</li>
<li>%build          一系列命令来执行软件的构建</li>
<li>%install        一系列命令来完成从%builddir到%buildroot目录的拷贝 （这里只有在创建pkg的时候，不是实际的用户环境的安装过程）</li>
<li>%check          一些列命令来测试软件，比如包括 unit test case</li>
<li>%pre            在安装pkg之前执行</li>
<li>%post           在安装pkg之后执行</li>
<li>%preun          在卸载pkg之前执行</li>
<li>%postun         在卸载pkg之后执行</li>
</ul>
<h2 id="macro">宏 macro</h2>
<p>spec内置2个简单的宏来执行特定的任务</p>
<ul>
<li>%setup      用来解压源代码，需要SOURCE</li>
<li>%patch      用来给代码打补丁, 需要PATCH</li>
</ul>
<p>同时用户可以自己定义宏， 包含两种宏。</p>
<ul>
<li>Simple Macros : 直接的文本替换</li>
<li>Parameterized Macros ： 包含选项字段，将下一行用空格分隔的字段设为args</li>
</ul>
<p>定义</p>
<pre><code>%define &lt;name&gt;[(opts)] &lt;body&gt;
</code></pre>
<p>包围body的空格都会被移除。 name 可以是字母数字和_组成，长度最少是3个字符。</p>
<p>如果没有opts,macro只执行展开操作。</p>
<p>如果opts中有参数的话，它的处理方式是<a href="https://linux.die.net/man/3/getopt">getopt</a>。宏中的可用变量是：
-   %0      被调用宏的名称
-   %<em>      所有参数，不包括处理标志
-   %</em><em>     所有参数，包括处理标志
-   %#      参数数量
-   %{-f}   调用出现时,标志f的本身
-   %{-f</em>}  调用出现时,标志f指向的参数
-   %1, %2  参数本身</p>
<p>无参数宏的情况下上面的变量都会废弃。</p>
<p>%{flag} 取flag</p>
<p>%{?flag:X} 如果flag出现则为falg,不出现则为X</p>
<p>%{!?flag:X} 和上面相反</p>
<p>%(shell command) 执行结果即输出 ， 如%(date +%%y%%m%%d) ，这里的%%转义为命令执行中的% 避免再次展开</p>
<p>下面是可用来执行内嵌宏</p>
<ul>
<li>%trace          打印扩展前后的调试信息</li>
<li>%dump           打印可用宏列表</li>
<li>%getncpus       可用cpu数量</li>
<li>%dnl            放弃下一行，不展开(&gt;=4.15.0)</li>
<li>%{echo:...}     打印到stdout</li>
<li>%{warn:...}     打印到stderr</li>
<li>%{error:...}    打印到stderr，并报错</li>
<li>%define ...     定义宏，lazy展开</li>
<li>%undefine ...   取消宏定义</li>
<li>%global ...     定义全局可用宏 ， eager展开</li>
<li>%{load:...}     加载宏文件(&gt;=4.12.0)</li>
<li>%{expand:...}   再次展开</li>
<li>%{shrink:...}   消除环绕的空格成一个空格(&gt;=4.14.0)</li>
<li>%{quote:...}    引用一个参数宏作为参数，传递空字符或由空格分隔的字符串</li>
<li>%{lua:...}      用lua来展开</li>
<li>%{uncompress:...}   用文件方式展开，并检查文件是否压缩，支持未压缩、gzip、bzip3种</li>
<li>%{basename:...} <a href="http://man7.org/linux/man-pages/man1/basename.1.html">basename</a></li>
<li>${dirname:...}  <a href="http://man7.org/linux/man-pages/man1/dirname.1.html">dirname</a></li>
<li>%{suffix:...}    expand to suffix part of a file name</li>
<li>%{url2path:...} 转换url为本地路径</li>
<li>%{getenv:...}   <a href="http://man7.org/linux/man-pages/man3/getenv.3.html">getenv</a></li>
<li>%{getconfdir:...}   rpm的home目录</li>
<li>%{S:...}        expand ... to <source> file name</li>
<li>%{P:...}        expand ... to <patch> file name</li>
<li>%{F:...}        expand ... to <file> file name</li>
</ul>
<p>默认变量地址 <strong>/usr/lib/rpm/macros</strong>   <strong>/etc/rpm/</strong></p>
<pre><code>rpm --eval '&lt;macro expression&gt;'   # 查看宏
</code></pre>
<p>使用宏</p>
<pre><code>%{&lt;name&gt;}       #直接展开成txt
%&lt;name&gt; ...     #如果有参数则进行调用
</code></pre>
<p>eg</p>
<pre><code>%define mymacro() (echo -n "My arg is %1" ; sleep %1 ; echo done.)
%mymacro 5
(echo -n "My arg is 5" ; sleep 5 ; echo done.)
</code></pre>
<p>autoconf中的宏变量</p>
<pre><code>    %_prefix            /usr
    %_exec_prefix       %{_prefix}
    %_bindir            %{_exec_prefix}/bin
    %_sbindir           %{_exec_prefix}/sbin
    %_libexecdir        %{_exec_prefix}/libexec
    %_datadir           %{_prefix}/share
    %_sysconfdir        %{_prefix}/etc
    %_sharedstatedir    %{_prefix}/com
    %_localstatedir     %{_prefix}/vars
    %_libdir            %{_exec_prefix}/lib
    %_includedir        %{_prefix}/include
    %_oldincludedir     /usr/include
    %_infodir           %{_prefix}/info
    %_mandir            %{_prefix}/man
</code></pre>
<h2 id="files">%files</h2>
<p>指向需要在构建系统中打包进rpm中的文件列表。 这些文件都会被作为参数执行2次，第一次是构建系统的路径，第二次是安装到目标系统的路径</p>
<p>%files包含了一些可用的指令</p>
<ul>
<li>明确配置文件、文档</li>
<li>检查文件的权限</li>
<li>控制pkg验证阶段的文件需要被检查的方面</li>
<li>消除一些创建%files列表时候的繁琐工作</li>
</ul>
<p>具体包括</p>
<ul>
<li>%attr   (<mode>,<user>,<group>)</li>
<li>%defattr (<file-mode>,<user>,<group>,<dir-mode>)</li>
<li>%doc</li>
<li>%config</li>
<li>%ghost  rpm知道但不在pkg的文件，如log</li>
<li>%docdir</li>
<li>%dir    指定目录下的所有信息都属于pkg，不用衍生的打印目录下的信息</li>
<li>-f <file>   文件中的每一行都是文件路径</li>
<li>%verify     验证特殊的文件，如设备文件<ul>
<li>owner</li>
<li>group</li>
<li>mode</li>
<li>md5</li>
<li>size</li>
<li>maj</li>
<li>min</li>
<li>symlink</li>
<li>mtime</li>
</ul>
</li>
</ul>
<h2 id="conditionals">条件 conditionals</h2>
<p>条件包括</p>
<ul>
<li>%ifarch</li>
<li>%ifnarch</li>
<li>%ifos</li>
<li>%ifnos</li>
<li>%else</li>
<li>%endif</li>
</ul>
<h1 id="engine">engine</h1>
<p>根据上面的一些知识点 初步整理的engine的spec文件情况如下图</p>
<p><img alt="ovirt-engine-spec" src="https://raw.githubusercontent.com/ShaneDean/file/a66e4024f1769b5dc16dde24d04dc443fdd768d6/blog/ovirt_engine_env/ovirt-engine-spec.png" /></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../development_environment/" class="btn btn-neutral float-left" title="开发环境"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../makefile/" class="btn btn-neutral float-right" title="makefile">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ShaneDean/note/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../development_environment/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../makefile/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
